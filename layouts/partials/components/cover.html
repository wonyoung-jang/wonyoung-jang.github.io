{{- with .cxt}} {{/* Apply proper context from dict */}}
    {{- if (and .Params.cover.image (not $.isHidden)) -}}
        {{- $alt := (.Params.cover.alt | default .Params.cover.caption | plainify) -}}
        
        <div class="entry-cover">
            {{- $responsiveImages := (.Params.cover.responsiveImages | default .Site.Params.cover.responsiveImages) | default true -}}
            {{- $addLink := (and .Site.Params.cover.linkFullImages (not $.IsHome)) -}}
            {{- $cover := (.Resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) -}}
            {{- if $cover -}}{{/* i.e it is present in page bundle */}}
                {{- if $addLink -}}
                    <a
                        href="{{- (path.Join .RelPermalink .Params.cover.image) | absURL -}}" 
                        target="_blank"
                        rel="noopener noreferrer">
                {{- end -}}

                {{- $sizes := (slice "360" "480" "720" "1080" "1500") -}}
                
                {{- $prod := (hugo.IsProduction | or (eq .Site.Params.env "production")) -}}
                
                {{- if (and ($responsiveImages) (eq $prod true)) -}}
                    {{- $webpCover := $cover.Resize "800x q75 webp" -}}
                    <picture>
                        <source type="image/webp" srcset="{{- range $size := $sizes -}}
                            {{- if (ge $cover.Width $size) -}}
                                {{- printf "%s %sw," (($cover.Resize (printf "%sx" $size)).Permalink) $size -}}
                            {{- end -}}
                        {{- end -}}
                        {{$webpCover.Permalink}} 800w">
                        <img    loading="lazy" 
                                srcset="{{- range $size := $sizes -}}
                                    {{- if (ge $cover.Width $size) -}}
                                        {{- printf "%s %sw," (($cover.Resize (printf "%sx" $size)).Permalink) $size -}}
                                    {{- end -}}
                                {{- end -}}
                                {{$cover.Permalink}} {{printf "%dw" ($cover.Width)}}" 
                                sizes="(min-width: 768px) 720px, 100vw" 
                                src="{{- $cover.Permalink -}}" 
                                alt="{{- $alt -}}" 
                                width="{{- $cover.Width -}}" 
                                height="{{- $cover.Height -}}">
                    </picture>
                {{- else -}}{{/* Unprocessable image or responsive images disabled */}}
                    <img    loading="lazy" 
                            src="{{- (path.Join .RelPermalink .Params.cover.image) | absURL -}}" 
                            alt="{{- $alt -}}">
                {{- end -}}
            {{- else -}}{{/* For absolute urls and external links, no img processing here */}}
                {{- if $addLink -}}
                    <a 
                        href="{{- (.Params.cover.image) | absURL -}}" 
                        target="_blank"
                        rel="noopener noreferrer">
                {{- end -}}
                    <img    loading="lazy" 
                            src="{{- (.Params.cover.image) | absURL -}}" 
                            alt="{{- $alt -}}">
            {{- end -}}

            {{- if $addLink -}}
                </a>
            {{- end -}}

            {{/*  Display Caption  */}}
            {{- if not $.IsHome -}}
                {{- with .Params.cover.caption -}}
                    <p>
                        {{- . | markdownify -}}
                    </p>
                {{- end -}}
            {{- end -}}
            
        </div>
    {{- end -}}{{/* End image */}}
{{- end -}}{{/* End context */ -}}
