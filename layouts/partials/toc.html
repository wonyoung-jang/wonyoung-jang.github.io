{{- $headers := findRE "<h[1-6].*?>(.|\n])+?</h[1-6]>" .Content -}}
{{- $has_headers := ge (len $headers) 1 -}}
{{- if $has_headers -}}

<div class="toc">


    <details {{if (.Param "TocOpen") }} open{{ end }}>

        <summary accesskey="c" title="Toggle Contents (ALT + SHIFT + c)">
            <span class="details">{{- i18n "toc" | default "Contents" }}</span>
        </summary>

        <div class="inner">
            {{- $prevHeaderLevel := 1 -}}
            {{- $topLevelHeader := 6 }}
            
            {{- range $i, $header := $headers -}}
                {{- $headerLevel := index (findRE "[1-6]" . 1) 0 -}}
                {{- $headerLevel := len (seq $headerLevel) -}}

                {{/* get id="xyz" */}}
                {{- $id := index (findRE "(id=\"(.*?)\")" $header 9) 0 }}

                {{- /* strip id="" to leave xyz, no way to get regex capturing groups in hugo */ -}}
                {{- $cleanedID := replace (replace $id "id=\"" "") "\"" "" }}
                {{- $header := replaceRE "<h[1-6].*?>((.|\n])+?)</h[1-6]>" "$1" $header -}}

                {{- if lt $headerLevel $topLevelHeader -}}
                    {{- $topLevelHeader = $headerLevel }}
                {{- end }}

                {{- if gt $headerLevel $prevHeaderLevel }}
                    {{- range seq (sub $headerLevel $prevHeaderLevel) }}
                        <ul>
                    {{- end }}
                {{- else if lt $headerLevel $prevHeaderLevel }}
                    {{- range seq (sub $prevHeaderLevel $headerLevel) }}
                        </ul>
                        </li>
                    {{- end }}
                {{- else }}
                    </li>
                {{- end }}

                <li>
                {{- $nextHeaderLevel := 0 -}}
                {{- if lt $i (sub (len $headers) 1) -}}
                    {{- $nextHeader := index $headers (add $i 1) -}}
                    {{- $nextHeaderLevel = len (seq (index (findRE "[1-6]" $nextHeader 1) 0)) -}}
                {{- end -}}

                {{- if gt $nextHeaderLevel $headerLevel }}
                    <details>
                        <summary>
                            <a href="#{{- $cleanedID -}}" aria-label="{{- $header | plainify -}}">{{- $header | safeHTML -}}</a>
                        </summary>
                {{- else }}
                        <a href="#{{- $cleanedID -}}" aria-label="{{- $header | plainify -}}">{{- $header | safeHTML -}}</a>
                {{- end }}

                {{- $prevHeaderLevel = $headerLevel -}}
            {{- end -}}

            {{- range seq (sub $prevHeaderLevel $topLevelHeader) }}
                </li>
                
            {{- end }}
        </div>
    </details>

    <div class="collapse-expand">

        <button class="collapse" aria-label="collapse all" title="Collapse All (ALT + SHIFT + p)" accesskey="p">   
            {{- i18n "collapse" | default "Collapse All" }}
        </button>
        
        <button class="expand" aria-label="expand all" title="Expand All (ALT + SHIFT + b)" accesskey="b">
            {{- i18n "expand" | default "Expand All" }}
        </button>

    </div>
</div>

<script>
    /* Toggle expand and collapse recursively */
    document.querySelector('.collapse').addEventListener('click', function() {
        document.querySelectorAll('.toc details').forEach(function(detail) {
            detail.removeAttribute('open');
        });
        document.querySelector('.expand').style.display = 'block';
        document.querySelector('.collapse').style.display = 'none';
    });

    document.querySelector('.expand').addEventListener('click', function() {
        document.querySelectorAll('.toc details').forEach(function(detail) {
            detail.setAttribute('open', '');
        });
        document.querySelector('.collapse').style.display = 'block';
        document.querySelector('.expand').style.display = 'none';
    });
</script>


{{- end }}